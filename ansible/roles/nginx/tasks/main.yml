---
- name: Include os-specific variables
  ansible.builtin.include_vars: "{{ item }}"
  with_first_found:
    - "../vars/{{ ansible_os_family }}.yml"
    - "../vars/default.yml"

- tags:
    - install
  block:
    - name: Remove Apache
      ansible.builtin.apt:
        name: '{{ apache_packages }}'
        state: absent
      when: apache_packages is defined

    - name: Install Nginx
      ansible.builtin.package:
        name: '{{ nginx_packages }}'
      notify: start nginx
      when: nginx_packages is defined

    - name: Install PHP
      ansible.builtin.package:
        name: '{{ php_fpm_packages }}'
      notify: start php-fpm
      when: php_enabled and php_fpm_packages is defined

    - name: Create nginx config directories
      ansible.builtin.file:
        path: "{{ nginx_root }}/{{ item }}"
        state: directory
        mode: 0755
      loop: "{{ nginx_config_dirs }}"

    - name: Copy static config files
      ansible.builtin.copy:
        src: nginx/
        dest: "{{ nginx_root }}"

- name: Create configurations
  ansible.builtin.import_tasks: configuration_nginx.yml

- name: Create PHP configurations
  ansible.builtin.import_tasks: configuration_php.yml
  when: php_enabled

- name: Create initial contents
  ansible.builtin.import_tasks: contents.yml
  when: content_enabled
